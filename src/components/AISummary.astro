---
import '../styles/ai-summary.css'; 
const { summary } = Astro.props;
---

<div id="ai-summary-wrapper" class="relative">
  <button id="ai-expand-btn" class="absolute right-4 top-[-3.5rem] force-hide expand-pure-icon">
    <img width="20" height="20" src="/gemini-color.png" alt="ai" class="relative z-10">
  </button>

  <div class="ai-summary-inner">
    <div id="ai-main-container" class="relative p-[1px] rounded-xl bg-[var(--primary)]/10 transition-all duration-300">
      <div id="ai-track" class="ai-border-track"></div>
      <div class="relative z-10 bg-[var(--card-bg)] rounded-[11px] p-4 flex flex-col overflow-hidden shadow-sm">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <div class="bg-[var(--primary)]/10 rounded-lg p-1">
              <img width="24" height="24" src="/gemini-color.png" alt="ai">
            </div>
            <span class="text-sm font-bold text-[var(--primary)] tracking-wider">AI 摘要</span>
          </div>
          <button id="ai-close-btn" class="p-2 text-[var(--primary)] hover:bg-[var(--primary)]/10 rounded-full transition-all cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div id="ai-type-target" class="text-sm leading-relaxed text-black/70 dark:text-white/70 font-medium is-typing-init" data-content={summary}></div>
      </div>
    </div>
  </div>
</div>

<script>
  function setupAI() {
    const wrapper = document.getElementById('ai-summary-wrapper');
    const main = document.getElementById('ai-main-container');
    const expandBtn = document.getElementById('ai-expand-btn');
    const textTarget = document.getElementById('ai-type-target');
    const track = document.getElementById('ai-track');
    const closeBtn = document.getElementById('ai-close-btn');

    if (!wrapper || !main || !expandBtn || !textTarget || !track || !closeBtn) return;

    let typingTimer;
    const ZWSP = '\u200B';

    function startTyping() {
      if (typingTimer) cancelAnimationFrame(typingTimer);
      const content = textTarget.getAttribute('data-content') || '';
      textTarget.innerText = ZWSP;
      textTarget.classList.remove('is-typing-init');
      track.style.opacity = '1';
      
      let i = 0;
      let lastTime = 0;
      const interval = 22; 

      function step(timestamp) {
        if (!lastTime) lastTime = timestamp;
        if (timestamp - lastTime >= interval) {
          if (i < content.length) {
            if (i === 0) textTarget.innerText = content.charAt(i++);
            else textTarget.innerText += content.charAt(i++);
            lastTime = timestamp;
            typingTimer = requestAnimationFrame(step);
          } else {
            setTimeout(() => { track.style.opacity = '0'; }, 500);
          }
        } else {
          typingTimer = requestAnimationFrame(step);
        }
      }
      typingTimer = requestAnimationFrame(step);
    }

    closeBtn.onclick = (e) => {
      e.preventDefault();
      if (typingTimer) cancelAnimationFrame(typingTimer);
      track.style.opacity = '0';
      main.classList.add('state-flying');
      setTimeout(() => {
        wrapper.classList.add('is-collapsed');
        textTarget.classList.add('is-typing-init');
        textTarget.innerText = ZWSP;
      }, 150);
      setTimeout(() => { expandBtn.classList.remove('force-hide'); }, 750);
      localStorage.setItem('ai-collapsed', 'true');
    };

    expandBtn.onclick = () => {
      localStorage.setItem('ai-collapsed', 'false');
      expandBtn.classList.add('force-hide');
      textTarget.innerText = ZWSP;
      textTarget.classList.add('is-typing-init');
      wrapper.classList.remove('is-collapsed');
      main.classList.remove('state-flying');
      setTimeout(startTyping, 550);
    };

    const isCollapsed = localStorage.getItem('ai-collapsed') === 'true';
    if (isCollapsed) {
      wrapper.classList.add('is-collapsed');
      expandBtn.classList.remove('force-hide');
      textTarget.innerText = ZWSP;
    } else {
      textTarget.innerText = ZWSP;
      setTimeout(startTyping, 800);
    }
  }

  document.addEventListener('astro:page-load', setupAI);
  document.addEventListener('swup:contentReplaced', setupAI);
  if (document.readyState === 'complete') setupAI();
  else window.addEventListener('load', setupAI);
</script>

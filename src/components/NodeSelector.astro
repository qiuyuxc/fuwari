---
const { class: className, style } = Astro.props;

const nodes = [
    { name: 'Edgeone', url: 'https://www.quiyun.com' },
    { name: 'Cloudflare', url: 'https://blog.quiyu.cn' },
    { name: 'ESA', url: 'https://esa.quiyu.cn' },
];
---

<div class:list={["card-base p-4 w-full", className]} style={style}>
    <div class="flex items-center gap-2 mb-4 border-b border-dashed border-black/5 dark:border-white/5 pb-3">
        <div class="w-1.5 h-4 rounded-full bg-[var(--primary)]"></div>
        <span class="text-[0.85rem] font-bold text-black/70 dark:text-white/80">
            节点切换
        </span>
    </div>

    <div id="node-container" class="flex flex-col gap-2">
        {nodes.map((node) => (
            <div 
                class="node-item flex items-center justify-between px-3 py-2.5 rounded-xl bg-black/5 dark:bg-white/5 hover:bg-[var(--primary)]/10 border border-transparent hover:border-[var(--primary)]/20 transition-all cursor-pointer group"
                onclick={`window.location.href='${node.url}'`}
                data-url={node.url}
            >
                <div class="flex flex-col min-w-0 text-left">
                    <span class="text-[0.8rem] font-medium text-black/70 dark:text-white/80 group-hover:text-[var(--primary)] transition-colors truncate">
                        {node.name}
                    </span>
                    <span class="text-[0.65rem] text-black/30 dark:text-white/30 font-mono truncate">
                        {new URL(node.url).hostname}
                    </span>
                </div>
                <span class="node-ping text-[0.7rem] font-mono font-bold text-black/40 dark:text-white/40 ml-2">
                    ...
                </span>
            </div>
        ))}
    </div>
</div>

<script is:inline>
    (function() {
        async function runPings() {
            const container = document.getElementById('node-container');
            const items = Array.from(document.querySelectorAll('.node-item'));
            const results = [];

            items.forEach(async (item) => {
                const pingEl = item.querySelector('.node-ping');
                const url = item.getAttribute('data-url');
                const testUrl = `${url.replace(/\/$/, '')}/favicon.ico?t=${Date.now()}`;
                
                try {
                    await fetch(testUrl, { mode: 'no-cors', cache: 'no-cache' }).catch(() => {});
                    const start = performance.now();
                    await fetch(testUrl, { mode: 'no-cors', cache: 'no-cache', priority: 'high' });
                    const diff = Math.round(performance.now() - start);

                    pingEl.innerText = `${diff}ms`;
                    pingEl.classList.remove('text-black/40', 'dark:text-white/40');
                    
                    if (diff < 200) pingEl.style.color = '#10b981';
                    else if (diff < 500) pingEl.style.color = '#f59e0b';
                    else pingEl.style.color = '#ef4444';

                    results.push({ item, diff });
                } catch (e) {
                    pingEl.innerText = '超时';
                    pingEl.style.color = '#ef4444';
                    results.push({ item, diff: 9999 });
                }

                if (results.length === items.length) {
                    results.sort((a, b) => a.diff - b.diff);
                    results.forEach((res, index) => {
                        res.item.style.order = index;
                    });
                }
            });
        }

        runPings();
        document.addEventListener('astro:page-load', runPings);
    })();
</script>
